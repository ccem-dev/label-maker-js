(function() {
  'use strict';
  
  angular
    .module('otusjs.labelMaker.setupView',[]);
}());

(function() {
  'use strict';

  angular
    .module('otusjs.labelMaker.setupView')
    .component('labelMaker', {
      template:'<div layout="row" layout-align="center center"><md-button class="md-raised md-primary" ng-click="$ctrl.generateLabelPage()">Gerar Etiquetas</md-button></div>',
      controller: Controller,
      bindings: {
        labelData: '<'
      }
    });

  Controller.$inject = [
    '$scope',
    '$rootScope',
    '$compile',
    '$element',
    'otusjs.labelMaker.labelBuilder.LabelService'
  ];

  function Controller($scope, $rootScope, $compile, $element, LabelService) {
    var self = this;
    var LABEL_PAGE = '<label-page/>';

    self.generateLabelPage = generateLabelPage;

    $scope.$on("Data_Ready", function(event) {
      self.ready = true;
    });

    $scope.$on("Data_Error", function(event) {
      self.dataError = true;
    });

    function generateLabelPage() {
      var scope = $rootScope.$new();
      scope.labelData = self.labelData;
      var labelPage = $compile(LABEL_PAGE)(scope);
    }

  }
}());

(function() {
  'use strict';

  angular
    .module('otusjs.labelMaker.labelBuilder',[
      'otusjs.labelMaker.labelBuilder.labelComponents'
    ]);
}());

(function() {
  'use strict';

  angular
    .module('otusjs.labelMaker.labelBuilder')
    .service('otusjs.labelMaker.labelBuilder.LabelService', Service);

  Service.$inject = [
     '$compile',
      'otusjs.labelMaker.dataBuilder.DataBuilderService',
    ];

  function Service($compile, DataBuilderService) {
    var self = this;

    _init();
    /* Public Interface */
    self.getBioMaterialList = getBioMaterialList;
    self.getBaseInfo = getBaseInfo;
    self.getLaboratoryInfo = getLaboratoryInfo;
    self.pushInfo = pushInfo;

    function _init() {
      //DataBuilderService.fetchTubesData();
    }

    function pushInfo(json) {
      return DataBuilderService.pushInfo(json);
    }

    function getLaboratoryInfo() {
      return DataBuilderService.getLaboratoryInfo();
    }

    function getBaseInfo() {
      return DataBuilderService.getBaseInfo();
   }

    function getBioMaterialList($scope) {
      return DataBuilderService.getBioMaterialList();
    }

  }
}());

(function() {
  'use strict';

  angular
    .module('otusjs.labelMaker.labelBuilder.labelComponents', [])
    .constant(
      'BARCODE_DEFAULT_SETTINGS', {
        format: 'CODE39',
        width: 1.1,
        height: 15,
        displayValue: true,
        font: "monospace",
        textAlign: "center",
        fontSize: 10,
        //   backgroundColor: "",
        //   lineColor: "#000"
      }
    ).constant(
      'BARCODE_SMALL_SETTINGS', {
        format: 'CODE39',
        width: 0.5,
        height: 20,
        displayValue: true,
        font: "monospace",
        textAlign: "center",
        fontSize: 10,
        //   backgroundColor: "",
        //   lineColor: "#000"
      });
}());

(function() {
    'use strict';

    angular
      .module('otusjs.labelMaker.labelBuilder.labelComponents')
      .component('defaultLabel', {
          transclude: true,
          template:'<div ng-show="$ctrl.componentLabel == \'participant\'" class="default-label"><div class="default-label-text"><h3>{{$ctrl.baseInfo.participant_name}}</h3><span>CQ:{{$ctrl.baseInfo.cq_group}}</span><br></div><svg id="participant" class="barcode"></svg></div><div ng-show="$ctrl.componentLabel == \'biomaterial\'" class="default-label"><p>{{$ctrl.biomaterial.label}}</p><div ng-style=\'{"overflow": "hidden","white-space": "nowrap","text-overflow": "ellipsis"}\'><span>{{$ctrl.baseInfo.participant_name}}</span><br></div><div layout-align="space-between center" layout="row" flex><span>NR:{{$ctrl.baseInfo.recruitment_number}}</span> <span>Sexo:{{$ctrl.baseInfo.gender}}</span></div><div layout-align="space-between center" layout="row" flex><span>DN:{{$ctrl.baseInfo.birthday}}</span> <span ng-show="$ctrl.baseInfo.laboratoryIdentification != null">Kit: {{$ctrl.baseInfo.laboratoryIdentification}}</span></div><svg id="biomaterial" class="barcode"></svg></div><div ng-show="$ctrl.componentLabel == \'unattached\'" class="default-label"><div class="default-label-text"><p>Laboratório</p><span>Centro:{{$ctrl.baseInfo.laboratoryFieldCenter}}</span><br><span>CQ:{{$ctrl.baseInfo.cq_group}}</span><br></div><svg id="unattached" class="barcode"></svg></div>',
          controller: Controller,
          bindings: {
            componentLabel: "<",
            base: '<',
            biomaterial: '<'
          }
      });

      Controller.$inject = [
        '$scope',
        '$element',
        '$compile',
        'BARCODE_DEFAULT_SETTINGS'
      ];

      function Controller($scope, $element, $compile, BARCODE_DEFAULT_SETTINGS) {
        var self = this;

        self.renderBarcode = renderBarcode;
        self.baseInfo = angular.copy(self.base);

        self.$onInit = function() {
          $compile($element.contents())($scope);
          renderBarcode();
        };

        function renderBarcode() {
          const barcodeContainer = $element.find(`svg`);
          for(var i = 0; i < barcodeContainer.length; i++) {
            if(barcodeContainer[i].id == "participant" &&
               self.componentLabel == 'participant') {
              JsBarcode(barcodeContainer[i], self.baseInfo.recruitment_number, BARCODE_DEFAULT_SETTINGS);
            }

            if(barcodeContainer[i].id == "biomaterial" &&
               self.componentLabel == 'biomaterial') {
              JsBarcode(barcodeContainer[i], self.biomaterial.code, BARCODE_DEFAULT_SETTINGS);
            }

            if(barcodeContainer[i].id == "unattached" &&
               self.componentLabel == 'unattached') {
              JsBarcode(barcodeContainer[i], self.baseInfo.laboratoryIdentification, BARCODE_DEFAULT_SETTINGS)
            }
          }
        }
      }
}());

(function() {
    'use strict';

    angular
      .module('otusjs.labelMaker.labelBuilder.labelComponents')
      .component('smallLabel', {
          transclude: true,
          template:'<div ng-show="$ctrl.componentLabel == \'participant\'" class="small-label"><div class="small-label-text"><h3>{{$ctrl.baseInfo.participant_name}}</h3><span>CQ:{{$ctrl.baseInfo.cq_group}}</span><br></div><svg id="participant" class="barcode"></svg></div><div ng-show="$ctrl.componentLabel == \'biomaterial\'" layout="row" class="small-label"><div class="small-useble-label"><div><span>{{$ctrl.material.label}}</span></div><div ng-style=\'{"overflow": "hidden","white-space": "nowrap","text-overflow": "ellipsis"}\'><span>{{$ctrl.baseInfo.participant_name}}</span><br></div><div layout="row" flex><span>NR:{{$ctrl.baseInfo.recruitment_number}}</span></div><svg id="biomaterial" class="barcode"></svg></div><div class="small-unuseble-label"></div></div><div ng-show="$ctrl.componentLabel == \'unattached\'" class="small-label"><div class="small-label-text"><p>Laboratório</p><span>Centro:{{$ctrl.baseInfo.laboratoryFieldCenter}}</span><br><span>CQ:{{$ctrl.baseInfo.cq_group}}</span><br></div><svg id="unattached" class="barcode"></svg></div>',
          controller: Controller,
          bindings: {
            componentLabel: "<",
            base: '<',
            biomaterial: '<'
          }
      });

      Controller.$inject = [
        '$scope',
        '$element',
        '$compile',
        'BARCODE_SMALL_SETTINGS'
      ];

      function Controller($scope, $element, $compile, BARCODE_SETTINGS) {
        var self = this;

        self.renderBarcode = renderBarcode;
        self.baseInfo = angular.copy(self.base);

        self.$onInit = function() {
          $compile($element.contents())($scope);
          console.info("here")
          renderBarcode();
        };

        function renderBarcode() {
          const barcodeContainer = $element.find(`svg`);
          for(var i = 0; i < barcodeContainer.length; i++) {
            if(barcodeContainer[i].id == "participant" &&
               self.componentLabel == 'participant') {
              JsBarcode(barcodeContainer[i], self.baseInfo.recruitment_number, BARCODE_SETTINGS);
            }

            if(barcodeContainer[i].id == "biomaterial" &&
               self.componentLabel == 'biomaterial') {
              JsBarcode(barcodeContainer[i], self.biomaterial.code, BARCODE_SETTINGS);
            }

            if(barcodeContainer[i].id == "unattached" &&
               self.componentLabel == 'unattached') {
              JsBarcode(barcodeContainer[i], self.baseInfo.laboratoryIdentification, BARCODE_SETTINGS)
            }
          }
        }
      }
}());

(function() {
  'use strict';

  angular
    .module('otusjs.labelMaker.labelBuilder.labelComponents')
    .component('biomaterialLabel', {
      transclude: true,
      template:'<div><default-label ng-repeat="biomaterial in $ctrl.biomaterialList" biomaterial="biomaterial" base="$ctrl.baseInfo" component-label="\'biomaterial\'"><small-label ng-repeat="biomaterial in $ctrl.biomaterialList" biomaterial="biomaterial" base="$ctrl.baseInfo" component-label="\'biomaterial\'"></small-label></default-label></div>',
      controller: Controller,
      bindings: {
        base: '<',
        biomaterialList: '<'
      }
    });

  Controller.$inject = [
    '$scope',
    '$element',
    '$compile'
  ];

  function Controller($scope, $element, $compile) {
    var self = this;

    self.baseInfo = angular.copy(self.base);
    self.$onInit = function() {
      console.info(self.bioMaterialList)
      $compile($element.contents())($scope);
    };
  }
}());

(function() {
    'use strict';

    angular
      .module('otusjs.labelMaker.labelBuilder.labelComponents')
      .component('participantLabel', {
          transclude: true,
          template:'<div><default-label component-label="\'participant\'" base="$ctrl.baseInfo"></default-label></div>',
          controller: Controller,
          bindings: {
            base: '<'
          }
      });

      Controller.$inject = [
        '$scope',
        '$element',
        '$compile',
      ];

      function Controller($scope, $element, $compile) {
        var self = this;

        self.baseInfo = angular.copy(self.base);

        self.$onInit = function() {
          $compile($element.contents())($scope);
        };

      }
}());

(function() {
    'use strict';

    angular
      .module('otusjs.labelMaker.labelBuilder.labelComponents')
      .component('unattachedLabel', {
          transclude: true,
          template:'<div><default-label component-label="\'unattached\'" base="$ctrl.baseInfo"></default-label></div>',
          controller: Controller,
          bindings: {
            base: '<',
            labInfo: '='
          }
      });

      Controller.$inject = [
        '$scope',
        '$element',
        '$compile',
      ];

      function Controller($scope, $element, $compile) {
        var self = this;

        self.baseInfo = angular.copy(self.base);

        self.$onInit = function() {
          $compile($element.contents())($scope);
        };

      }
}());

(function () {
  'use strict';

  angular
    .module('otusjs.labelMaker.labelPage', []);
}());

(function() {
  'use strict';

  angular
    .module('otusjs.labelMaker.labelPage')
    .directive('labelPage', directive);

  directive.$inject = [
    '$window',
    '$compile',
    'otusjs.labelMaker.labelBuilder.LabelService'
  ];

  function directive($window, $compile, LabelService) {
    var ddo = {
      restrict: 'EA',
      scope: {},
      transclude: true,
      template:'<div id="print-page" layout-align="start center" ng-if="$ctrl.loadComponents"><unattached-label base="$ctrl.laboratoryInfo"><participant-label base="$ctrl.baseInfo"><biomaterial-label base="$ctrl.baseInfo" biomaterial-list="$ctrl.bioMaterialList"></biomaterial-label></participant-label></unattached-label></div>',
      controller: Controller,
      controllerAs: '$ctrl',
    };

    function Controller($element, $scope) {
      var self = this;
      self.printPage = self.printPage;

      init();

      function init() {
        self.baseInfo = {};
        self.bioMaterialList = [];
        LabelService.pushInfo($scope.$parent.labelData);
        _setInfo();
      }

      function _setInfo() {
        self.bioMaterialList = LabelService.getBioMaterialList();
        self.baseInfo = LabelService.getBaseInfo();
        console.info(self.baseInfo)
        self.laboratoryInfo = LabelService.getLaboratoryInfo();
        self.loadComponents = true;
      }

      $scope.$$postDigest(function() {
        _generateWindow();
      });

      function _generateWindow() {
        var newWindow = $window.open('about:blank', '_blank');

        newWindow.document.write('<html>' +
          '<head><title>Etiquetas</title>' +
          '<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic" rel="stylesheet" />' +
          '<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />' +
          '<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.1/angular-material.min.css">' +
          '<link rel="stylesheet" type="text/css" href="node_modules/label-maker-js/dist/label-maker-js/css/otusjs-label-page.min.css"/>' +
          '</head>' +
          '<button class="no-print button-print md-button md-fab md-mini" onclick="window.print()" >' +
          '<i class="material-icons white">print</i>'+
          '</button>' +
          '<body></body>' +
          '<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js" type="text/javascript"></script></html>');

         angular.element(newWindow.document.body)
          .append($element.contents());

        newWindow.document.close();
      }

    }
    return ddo;
  }
}());

(function() {
  'use strict';

  angular
    .module('otusjs.labelMaker.dataBuilder',['ngResource']);
}());

(function () {
  'use strict';

  angular
    .module('otusjs.labelMaker.dataBuilder')
    .service('otusjs.labelMaker.dataBuilder.DataBuilderService', Service);

  Service.$inject = [
    '$rootScope',
    '$resource'
  ];

  function Service($rootScope, $resource) {
    var self = this,

      _baseInfo = {},
      _unattachedLaboratoryInfo = {},
      _bioMaterialList,
      baseInfoModel = {
        cq_group: null,
        participant_name: null,
        recruitment_number: null,
        gender: null,
        birthday: null
      },
      unattachedLaboratoryInfoModel = {
        cq_group: null,
        laboratoryIdentification: null,
        laboratoryFieldCenter: null
      };

    self.fetchBioMaterialData = fetchBioMaterialData;
    self.getBaseInfo = getBaseInfo;
    self.getLaboratoryInfo = getLaboratoryInfo;
    self.getBioMaterialList = getBioMaterialList;
    self.pushInfo = pushInfo;

    function fetchBioMaterialData() {
      _getInfo().getData().$promise
        .then(function (data) {
          _setInfo(data);
          $rootScope.$broadcast("Data_Ready", data);
        })
        .catch(function (err) {
          $rootScope.$broadcast("Data_Error", err); //TODO set listener
        });
    }

    function getBaseInfo() {
      return _baseInfo;
    }

    function getLaboratoryInfo() {
      return _unattachedLaboratoryInfo;
    }

    function getBioMaterialList() {
      return _bioMaterialList;
    }

    function _setInfo(data) {
      angular.extend(_baseInfo, baseInfoModel, data);
      angular.extend(_unattachedLaboratoryInfo, unattachedLaboratoryInfoModel, data);
      _bioMaterialList = data.tubes ? data.tubes : data.aliquots ;
    }

    function pushInfo(labParticipant) {
      if (labParticipant) {
        var parse = labParticipant;
        _setInfo(parse);
      } else {
        fetchBioMaterialData();
      }
    }

    function _getInfo() {
      var params = {
        participant_id: ''
      };

      return $resource('app/assets/participant-tubes-set.json', params, {
        getData: {
          method: 'GET',
          isArray: false
        }
      });
    }
  }
}());
